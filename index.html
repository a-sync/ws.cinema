<!DOCTYPE html>
<html class="cinema_bg">
	<head>
		<title>ws.cinema</title>
		<!-- src @ github.com/a-sync/ws.cinema -->

		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="mobile-web-app-capable" content="yes">

		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" >

		<link rel="icon" href="favicon.png">
		<link rel="apple-touch-icon" href="favicon.png">
		<link rel="stylesheet" href="bootstrap.min.css">
		<link rel="stylesheet" href="animate.min.css">
		<link rel="stylesheet" href="styles.css">

		<script src="JQ.js"></script>
		<script src="jquery.achexws.js"></script>
		<script src="webtorrent.min.js"></script>
		<script>
$.fn.extend({
    animateCss: function (animationName) {
        var animationEnd = 'webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend';
        this.addClass('animated ' + animationName).one(animationEnd, function() {
            $(this).removeClass('animated ' + animationName);
        });
    }
});
var backgroundCs = [
    {cname:'black_bg'},
    {cname:'cinema_bg'},
    {cname:'brokkoli_bg'},
    {cname:'cosmos_bg'},
    {cname:'black-scales_bg'},
    {cname:'diagmonds_bg'}
];
function setBg(newBgNum) {
    if( typeof(window.localStorage.currBg) === 'undefined' 
        || isNaN(window.localStorage.currBg) 
        || typeof(backgroundCs[window.localStorage.currBg]) !== 'object') {
        
        window.localStorage.currBg = 1;
    }

    if(isNaN(newBgNum) || typeof(backgroundCs[newBgNum]) !== 'object') {
        newBgNum = window.localStorage.currBg;
    }
    else window.localStorage.currBg = newBgNum;

    document.getElementsByTagName('html')[0].className = backgroundCs[newBgNum].cname;
}
        </script>

	</head>
	<body onload="loadInit()">
	<div id="main-content">
            <video id="the-video" src="" poster=""></video><!-- crossorigin="anonymous" -->
			<div id="chat_cont">
				<div>
					<div id="username-container">Username:&nbsp;<span id="username"></span></div>
					<div id="users-title"><canvas id="logo" width="25" height="25"></canvas>Users</div>
				</div>
				<div>
					<div id="chat_window"></div>
					<div id="chat_users"></div>
					<div id="chat_channels"></div> 
				</div>
				<div id="chat-tooltip-container"><div id="chat-tooltip"></div></div>
				<div id="chat-input-container">
                    <div id="chat-input-left">
                        <a id="bookmarklet" onclick="alert(this.title);return false;" class="btn btn-xs" title="Get video source URL from any website. Save this link as a bookmark via drag and drop or other method and run it on your favorite streaming site after a video started playing." href="javascript:(function()%7Bfunction%20f(e)%7Btry%7Bvar%20r%3De.document.getElementsByTagName(%22video%22)%3Bfor(var%20i%20in%20r)if(r%5Bi%5D.readyState%3E0%26%26!r%5Bi%5D.paused)return%20prompt(%22Copy%20video%20source%20URL%3A%22%2Cr%5Bi%5D.currentSrc)%2C!1%7Dcatch(t)%7B%7Dreturn!0%7Dif(f(window))%7Bfor(var%20c%3D0%3Bc%3Cwindow.frames.length%26%26f(window.frames%5Bc%5D)%3B)c%2B%2B%3Bif(c%3E%3Dwindow.frames.length)%7Bvar%20i%3Dwindow.document.querySelector(%22iframe%5Ballowfullscreen%5D%22)%2Ct%3D%22Can't%20detect%20currently%20playing%20video.%22%3Bi%26%26i.src%26%26window.location.href!%3Di.src%3Fconfirm(t%2B%22%20Retry%20inside%20iframe%3F%22)%26%26(window.location.href%3Di.src)%3Aalert(t)%7D%7D%7D)()">GET-VIDEO-SOURCE</a>
                        <button id="set-video" type="button" class="btn btn-warning btn-xs" onclick="javascript:setVideo()" alt="/video">SET VIDEO</button>
                    </div>
                    <button id="pp-btn" type="button" class="btn btn-info btn-xs round-btn" style="padding-left:3px;font-size:0.6em" onclick="javascript:TheVideoController.pp()" alt="/p">&#9658;&#10074;&#10074;</button>
                    <button type="button" class="btn btn-info btn-xs round-btn" style="padding-left:4px;font-size:1.1em" onclick="javascript:TheVideoController.seek(-10)" alt="/s -10">&#11244;</button>
                    <button type="button" class="btn btn-info btn-xs round-btn" style="padding-left:6px;font-size:1.1em" onclick="javascript:TheVideoController.seek(10)" alt="/s +10">&#11246;</button>
                    <button type="button" class="btn btn-info btn-xs round-btn" style="padding-top:1px;font-size:14px" onclick="javascript:TheVideoController.volDn()" alt="/v -10">&#x2212;</button>
                    <button type="button" class="btn btn-info btn-xs round-btn" style="padding-top:1px;font-size:14px" onclick="javascript:TheVideoController.volUp()" alt="/v +10">&#x2b;</button>
                    <button type="button" class="btn btn-info btn-xs" onclick="javascript:TheVideoController.toggleControls()" alt="/c">&#x25b2;</button>
                    &nbsp;
                    <input id="chat_input" type="text">&nbsp;<button type="button" class="btn btn-primary btn-xs" onclick="javascript:sendChat()">SEND</button>
                    <button type="button" class="btn btn-danger btn-xs" onclick="javascript:clearChatWindow()" alt="/cls">CLEAR</button>
                    <button type="button" class="btn btn-success btn-xs" onclick="javascript:TheVideoController.fullScreen()" alt="/fs"><img height="15" src="favicon.png"/></button>
				</div>
			</div>
	</div>

		<div id="log"></div>
<script>
//TODO: remove messages after time delay
var users = [];
var channels = [];
var channel = window.location.hash.length>1?window.location.hash.replace(/\W+/g, ""):'lobby';
if(window.location.hash.length<2) window.location.hash = channel;
var bcChannel = 'cinema-'+channel;

var username = window.localStorage.username || '';
var firstRun = false;
while(username == ''){
	username = prompt('Enter Username').replace(/\W+/g, "");
	window.localStorage.username = username;
	firstRun = true;
}
$('#username').html(username);

function oc(e){
    console.log('connection opened');

    $.achex.send({joinHub:bcChannel});
	refreshUserList();

	if(firstRun === true) {
        htmlToSelf('Set a hosted video url or <a href="https://a-sync.github.io/BTorrent/" target="_blank">magnet uri</a> for the room player,<br>'
        +'then sync up with others and control the playback together :)<br>', 'Welcome');
        firstRun = false;
    }
    htmlToSelf('You joined room <b>'+channel+'</b><br>List available commands with <b>/help</b><br>', 'Welcome');

    lastUser = null;
}

function loadInit() {
    setBg();
    setPoster();

    TheVideoController.init('the-video');

    if(!input) input = document.getElementById('chat_input');
    input.focus();
    window.onclick = function() {
        if(input.focus) input.focus();
    };
}

function cc(){
	$.achex.send({toH:bcChannel, offline: username});
	console.log('closed');// TODO htmlToSelf notification
}

var refreshTimeout = null;
var refreshUsersTimeout = null;
function chatEvent(obj, raw){ // Notes to update to v2: http://achex.ca/develop/#server_commands
	if(obj == null) return;
    
    if(obj.ltcy){
        console.log('LATENCY', obj.ltcy);
    }else if(obj.joinHub){
        users[$.achex.sid] = {c:$.achex.username};
        showUsers();
    }else if(obj.leftHub == bcChannel){
        delete users[obj.sID];
        showUsers();
    }else if(obj.toH && obj.toH == bcChannel){
		if( obj.channel == channel && channel != '' ){
			// received chat
			rcvChat(obj);
		}else if(obj.req != null){
            //console.log(obj);
            //if(obj.sID != $.achex.sid && typeof(users[obj.sID]) === 'undefined') htmlToSelf(esc(obj.FROM)+' joined the room');

            //users = [];
            if (obj.req === 'info' && obj.sID && obj.online === obj.FROM) {
                users[obj.sID] = {c:String(obj.FROM)};
            }
            showUsers();

            clearTimeout(refreshTimeout);
            refreshTimeout = setTimeout(refreshUserList, 60000);

			var to_send = {
                toH:bcChannel,
                inchannel: channel,
                myCurrSrc: !TheVideoController.video.currentSrc?TheVideoController.video.currentSrc:escape(TheVideoController.video.currentSrc),
                myCurrTime: TheVideoController.video.currentTime,
                myCurrTorrent: !TheVideoController.torrent?TheVideoController.torrent:escape(TheVideoController.torrent),
                myCurrTorrentFileId: TheVideoController.torrentFileId
			};
			//console.log(to_send);
			$.achex.send(to_send);
		}else if(obj.inchannel != null){
            if(obj.inchannel == channel){
                users[obj.sID] = {c:String(obj.FROM)};

                clearTimeout(refreshUsersTimeout);
                refreshUsersTimeout = setTimeout(showUsers, 1000);

                if(!TheVideoController.video.currentSrc 
                    && typeof(obj.myCurrSrc) === 'string' 
                    && (unescape(obj.myCurrSrc).slice(0, 7) === 'http://' 
                        || unescape(obj.myCurrSrc).slice(0, 8) === 'https://' 
                        || (unescape(obj.myCurrSrc).slice(0, 5) === 'blob:' 
                            && obj.myCurrTorrent != null && !isNaN(obj.myCurrTorrentFileId) 
                            && obj.myCurrTorrentFileId+unescape(obj.myCurrTorrent) != 
                               TheVideoController.torrentFileId+TheVideoController.torrent)) 
                    && unescape(obj.myCurrSrc) != TheVideoController.video.currentSrc
                ) {
                    TheVideoController.lastSyncTimeStamp = Date.now();
                    TheVideoController.lastSyncObj = {videoCurrTime: obj.myCurrTime};

                    if(unescape(obj.myCurrSrc).slice(0, 5) === 'blob:') {
                        if(obj.myCurrTorrent != null && !isNaN(obj.myCurrTorrentFileId)) {
                            loadWithWebTorrent(unescape(obj.myCurrTorrent), obj.myCurrTorrentFileId, function(fid, n){
                                if(fid === null) {
                                    if(n === 1) TheVideoController.ignoreEvents = true;
                                    else TheVideoController.startIgnoring();
                                }
                            });
                        }
                    }
                    else {
                        TheVideoController.startIgnoring();

                        TheVideoController.video.src = unescape(obj.myCurrSrc);
                        TheVideoController.video.currentTime = obj.myCurrTime;
                        destroyCurrTorrent();
                    }

                    setTimeout(function(){$('#chat_users > div.wsvs'+String(obj.sID)).addClass('user-syncing');setTimeout(function(){$('#chat_users > div.wsvs'+String(obj.sID)).removeClass('user-syncing');}, 400);}, 420);
                }
            }
		}else if(obj.gif != null) {
            var type = obj.gif.slice(-9);
            if(type === '/100.webp') {
                obj.gif = obj.gif.slice(0, obj.gif.length-9)+'/200.webp';
            }
            rcvChat(obj, '<img width="'+(obj.width*2)+'" '+(obj.width>190?'':'height="'+(obj.height*2)+'"')+' src="'+obj.gif+'" class="msg-gif loading" onload="this.className=\'msg-gif\'" />');
		}
		else if(obj.videoSrc != null) {
            if(TheVideoController.video.currentSrc != unescape(obj.videoSrc)) {
                TheVideoController.video.src = unescape(obj.videoSrc);
                TheVideoController.video.load();
                destroyCurrTorrent();
            }
            else TheVideoController.video.load();
		}
		else if(obj.magnetLink != null) {
            if(!isNaN(obj.fileId)  
               && obj.fileId+unescape(obj.magnetLink) != 
                  TheVideoController.torrentFileId+TheVideoController.torrent) {
                loadWithWebTorrent(unescape(obj.magnetLink), obj.fileId);
            }
            else TheVideoController.video.load();//debug
		}
		else if(obj.subSrc != null) {
            TheVideoController.addSub(unescape(obj.subSrc));
		}
		else if(obj.snap != null) {
            rcvChat(obj, '<img src="'+unescape(obj.snap)+'" class="msg-snap loading" onload="this.className=\'msg-snap\'" />');
		}
		else if(obj.videoCurrSrc != null) {
            TheVideoController.syncToMaster(obj);
            //console.log('videoCurrSrc', obj);
		}
		else if(obj.poster != null) {
            document.getElementById('the-video').setAttribute('poster', unescape(obj.poster));
		}

	}else if(obj.FROM && obj.FROM != username){
		if( obj.req == 'info'){
			$.achex.send({toH:bcChannel, inchannel: channel});
		}else{
			rcvWhisper(obj);
		}
	}
}

// dec2hex :: Integer -> String
function dec2hex (dec) {
    return ('0' + dec.toString(16)).substr(-2)
}
// generateId :: Integer -> String
function generateId(len) {
    var arr = new Uint8Array((len || 40) / 2)
    window.crypto.getRandomValues(arr)
    return Array.from(arr).map(dec2hex).join('')
}

while(!window.localStorage.password) {
    window.localStorage.password = generateId();
}

$.achex({
    //dbg: true,
	username: username,
	password:window.localStorage.password||'*',
	reconnect: 3000,
	logo:{canvas:'logo', size:25},
	opencallback: oc,
	callback: chatEvent,
	closecallback: cc
	//,url: 'wss://cloud.achex.ca' // wss://ws.achex.ca
	//,port: 443 // 4010
});

var cmdModeChars = [':','?'];
function cmdModeCharsReplacer(cmd) {
    if(!cmd) return cmd;

    var i = cmdModeChars.indexOf(cmd.slice(0,1));
    if(i >= 0) {
        return '/'+cmd.slice(1);
    }

    return cmd;
}
// ---- chat functions
function sendChat(){
	var str = cmdModeCharsReplacer(input.value);
	if(channel != null && str != null){
        if(str === '/clear' || str ==='/cls') {
            clearChatWindow();
        }
        else if(str === '/name' || str === '/nick') {
            username = prompt('Enter Username', username).replace(/\W+/g, '');
            if (username && window.localStorage.username != username) {
                window.localStorage.username = username;
                window.location.reload();
            }
            //TODO: reauth to server to get new name without reloading
        }
        else if(str === '/setvideo' || str === '/video') {
            setVideo();
        }
        else if(str === '/setmagnet' || str === '/magnet') {
            setMagnet();
        }
        else if(str === '/getsource') {
            if(!TheVideoController.video || !TheVideoController.video.currentSrc) htmlToSelf('No video source set.');
            else htmlToSelf(esc(TheVideoController.video.currentSrc));
        }
        else if(str === '/play' || str === '/pause' || str === '/p') {
            if(TheVideoController.video != null) {
                if(TheVideoController.video.paused) {
                    if(str === '/play' || str === '/p') TheVideoController.video.play();
                }
                else {
                    if(str === '/pause' || str === '/p') TheVideoController.video.pause();
                }
            }
            else htmlToSelf('No video loaded...');
        }
        else if(str === '/cb' || str == '/c') {
            TheVideoController.toggleControls();
        }
        else if((str.slice(0, 8) === '/volume ' || str.slice(0, 3) === '/v ') && !isNaN(parseInt(str.split(' ')[1]))) {
            if(!TheVideoController.setVol(str)) htmlToSelf('No video loaded...');
        }
        else if(str === '/mute' || str === '/unmute' || str === '/m') {
            if(TheVideoController.video != null) {
                if(!TheVideoController.video.muted) {
                    if(str === '/mute' || str === '/m') TheVideoController.video.muted = true;
                }
                else {
                    if(str === '/unmute' || str === '/m') TheVideoController.video.muted = false;
                }
            }
            else htmlToSelf('No video loaded...');
        }
        else if(str === '/fullscreen' || str === '/fs') {
            TheVideoController.fullScreen();
        }
        else if(str === '/master') {
            if(!TheVideoController.master) {
                TheVideoController.master = true;
                setSync();
                htmlToSelf('Entered master mode...');
            }
            else {
                TheVideoController.master = false;
                htmlToSelf('Exited master mode...');
            }
        }
        else if(str.slice(0, 11) === '/setposter ' && !isNaN(str.split(' ')[1])) {
            setPoster(parseInt(str.split(' ')[1]));
        }
        else if(str.slice(0, 7) === '/setbg ' && !isNaN(str.split(' ')[1])) {
            setBg(parseInt(str.split(' ')[1]));
        }
        else if(str === '/snap' || str.indexOf('/snap ') === 0) {
            if(TheVideoController.video != null) {
                var q = null;
                if(str.length > 6) {
                    if(!isNaN(str.split(' ')[1])) q = str.split(' ')[1];
                }

                TheVideoController.snap(q);
                if(TheVideoController.snapDataUrl !== null) {
                    var to_send = {toH:bcChannel, snap: escape(TheVideoController.snapDataUrl) };
                    $.achex.send(to_send);
                    rcvChat(Object.assign({FROM:$.achex.username, sID:$.achex.sid}, to_send), '<img src="'+TheVideoController.snapDataUrl+'" class="msg-snap loading" onload="this.className=\'msg-snap\'" />');
                }
            }
            else htmlToSelf('No video loaded...');
        }
        else if((str.slice(0, 6) === '/seek ' || str.slice(0, 3) === '/s ') 
                && str.split(' ').length > 1 && str.split(' ')[1] !== '') {
            TheVideoController.seek(str.split(' ')[1]);
        }
        else if(str === '/sync') {
            setSync();
        }
        else if((str.slice(0, 6) === '/room ' || str.slice(0, 3) === '/r ') 
                && str.split(' ').length > 1 && str.split(' ')[1] !== '') {
            setRoom(str.split(' ')[1]);
        }
        else if(str === '/subtitle' || str === '/sub') {
            setSubtitle();
        }
        else if(str.slice(0, 6) === '/cors ' && !isNaN(str.split(' ')[1])) {
            switch(parseInt(str.split(' ')[1])) {
                case 1: TheVideoController.setCORS('anonymous');
                    htmlToSelf('Video CORS policy set to anonymous.');
                    break;
                case 2: TheVideoController.setCORS('use-credentials');
                    htmlToSelf('Video CORS policy set to use-credentials.');
                    break;
                default: TheVideoController.setCORS();
                    htmlToSelf('Video CORS policy removed.');
            }
        }
        else if(str === '/top') {
            if(TheVideoController.video.style.zIndex != 777) {
                TheVideoController.video.style.zIndex = 777;
            }
            else {
                TheVideoController.video.style.zIndex = 'auto';
            }
        }
        else if(str === '/help' || str === '/man') {
            var cmdCharsList = '<b class="cmd-c hovered">/</b> ';
            for(var i = 0; i < cmdModeChars.length; i++) cmdCharsList += '<b class="cmd-c">'+cmdModeChars[i]+'</b> ';
            lastUser = null;
            htmlToSelf('<b>/name, /nick</b> '
                +'<br><b>/setbg</b> 0-'+(backgroundCs.length-1)+' '
                +'<br><b>/setposter</b> 0-'+(posterPs.length-1)+' '
                +'<br><b>/gif</b> (search via giphy) '
                +'<br><b>/sticker</b> (search via giphy) '
                +'<br><b>/giflate</b> (translate via giphy) '
                +'<br><b>/sticklate</b> (translate via giphy) '
                +'<br><b>/sync</b> (broadcast playback info) '
                +'<br><b>/cors</b> 0-2 (set CORS policy) '
                +'<br><b>/room, /r</b> (switch to room) '
                +'<br><b>/snap</b> 0-100 (quality) '
                +'<br><b>/getsource</b> '
              //+'<br><b>/master</b> '
            ,' Available commands');
            lastUser = null;
            htmlToSelf('<b>/help, /man</b> '
                +'<br><b>/fullscreen, /fs</b> '
                +'<br><b>/top</b> (toggle video on top) '
                +'<br><b>/cb, /c</b> (toggle control bar) '
                +'<br><b>/clear, /cls</b> (clear screen) '
                +'<br><b>/setvideo, /video</b> '
                +'<br><b>/setmagnet, /magnet</b> '
                +'<br><b>/subtitle, /sub</b> '
                +'<br><b>/play, /pause, /p</b> (toggle play / pause) '
                +'<br><b>/mute, /unmute, /m</b> (toggle mute) '
                +'<br><b>/volume, /v</b> 0-100 (or &#177;int) '
                +'<br><b>/seek, /s</b> m:s (or &#177;int) '
            ,' '+cmdCharsList);
            lastUser = null;

            var allCmdModeChars = ['?',':', '/'];
            var replaceCmdCharsInHelp = function(e) {
                $('span.from .cmd-c.hovered').removeClass('hovered');
                $(this).addClass('hovered');

                var cmdElemList = document.querySelectorAll('i.sys-msg > b');
                for(var i = 0; i < cmdElemList.length; i++) {
                    if(cmdElemList[i].textContent.length > 1) {
                        var firstChar = cmdElemList[i].textContent.slice(0,1);
                        var currentCmdChar = allCmdModeChars.indexOf(firstChar);

                        //console.log(currentCmdChar, cmdElemList[i].textContent, firstChar, allCmdModeChars[currentCmdChar]);
                        if(currentCmdChar !== -1) {
                            var r = new RegExp('\\'+allCmdModeChars[currentCmdChar], 'g');
                            cmdElemList[i].textContent = cmdElemList[i].textContent.replace(r, this.textContent);
                        }
                    }
                }
            }
            
            var cmdCharElemList = document.querySelectorAll('span.from > b.cmd-c');
            for(var i = 0; i < cmdCharElemList.length; i++) {
                cmdCharElemList[i].parentNode.style.textDecoration = 'none';
                cmdCharElemList[i].onmouseover = replaceCmdCharsInHelp;
            }
        }
        else {
            var to_send = {toH:bcChannel, channel: channel, msg : escape(input.value) };
            $.achex.send(to_send);
            rcvChat(Object.assign({FROM:$.achex.username, sID:$.achex.sid}, to_send));
            //console.log(to_send);
        }
        addToChatHistory(input.value);
        currHistoryEntry = null;
		input.value = '';
	}
}

function setRoom(str){
    window.location.hash = '#'+str.replace(/\W+/g, "");
    window.location.reload();
}

function htmlToSelf(html, title, sid) {
    if(!title) title = $.achex.username;
    var obj = {FROM:title, sID:sid||$.achex.sid};
    rcvChat(obj, '<i class="sys-msg">'+html+'</i>');
}

function setChannel(chan){
	channel = chan;
}

function sendWhisper(usr, str){
	$.achex.send({to:usr, channel:channel, msg:escape(str)});
}

function rcvChat(obj, html){
    if(lastUser != obj.sID) $('#chat_window').append(createChatMessage(obj, html));
	else $('#chat_window>div:last-child').append('<br>').append(createChatMessage(obj, html));
	input.scroll = input.scrollHeight;
}
function rcvWhisper(obj){
    if(lastUser != obj.sID) $('#chat_window').append(createChatMessage(obj)).css('color', 'darkorange');
	else $('#chat_window>div:last-child').append('<br>').append(createChatMessage(obj)).css('color', 'darkorange');
	input.scroll = input.scrollHeight;
}

var lastUser = null;
function createChatMessage(obj, html){
	var re = document.createElement('div');
	var msg = document.createElement('span');
	var from = document.createElement('span');

	from.className = 'from';
	from.innerHTML = obj.FROM;

	msg.className = 'msg';
	if(!html) {
        var msgText = unescape(obj.msg);
        msg.textContent = msgText;

        msgText = msgText.split(' ');
        var preSpace = '';
        var postSpace = ' ';
        for(var i = 0; i < msgText.length; i++) {
            if(i > 0) preSpace = ' ';
            if(i == msgText.length-1) postSpace = '';
            if(msgText[i].substr(0, 7) === 'http://' || msgText[i].substr(0, 8) === 'https://') {
                msg.innerHTML = msg.innerHTML.replace(
                    preSpace + msgText[i] + postSpace, 
                    preSpace + '<a href="'+esc(msgText[i])+'" target="_blank">'+esc(msgText[i])+'</a>' + postSpace
                );
            }
        }
    }
    else msg.innerHTML = html;
    
	if(obj.time != null){
		var time = document.createElement('span');
		time.innerHTML = obj.time;
		time.className = 'msg-time';
	}
	//TODO: send timestamp

	if(lastUser != obj.sID) {
        re.appendChild(from);
        re.appendChild(document.createElement('br'));
        re.appendChild(msg);
        re.className = 'animated fadeInRight';
	}
	else {
        re = msg;
        re.className = 'msg animated fadeInUp';
	}

    lastUser = obj.sID;
	return re;
}

var input = document.getElementById('chat_input');

input.onkeypress = function(e){
    //console.log('onkeypress', e.keyCode);
    var tmp = cmdModeCharsReplacer(input.value);
	switch(e.keyCode){
		case 13:
            if(tmp.slice(0, 9) === '/giflate ' 
            || tmp.slice(0, 5) === '/gif ' 
            || tmp === '/gif' 
            || tmp === '/gif ' 
            || tmp.slice(0, 11) === '/sticklate ' 
            || tmp.slice(0, 9) === '/sticker ' 
            || tmp === '/sticker' 
            || tmp === '/sticker ' 
            ) {
                var highlighted = $('#chat-tooltip > img.highlighted');
                if(highlighted.length !== 0) {
                    sendGif(highlighted.get(0));
                }
            }
            else sendChat();
		break;
		case 37:
		case 38:
		case 39:
		case 40:
            //e.preventDefault();  
            //e.returnValue = false;
            //e.cancelBubble = true;
            //return false;
		break;
	}
};

input.onkeydown = function(e) {
    if($('#chat-tooltip > img').length > 0 && 37 <= e.keyCode && e.keyCode <= 40) {
        e.preventDefault();  
        //e.returnValue = false;
        //e.cancelBubble = true;
        return false;
    }
};

var currHistoryEntry = null;
var chatHistory = [];
function addToChatHistory(cmd) {
    if(!cmd || chatHistory[0] == cmd) return false;
    chatHistory.unshift(cmd);
    currHistoryEntry = null;
    return true;
}

window.onkeydown = function(e) {
    //console.log('e.keyCode', e.keyCode);
    if(((37 > e.keyCode || e.keyCode > 40) && e.keyCode !== 27) || $('#chat-tooltip > img').length === 0) {
        if( (e.keyCode == 38 || e.keyCode == 40) && 
            (input.value === '' || currHistoryEntry !== null)
        ) {
            if(e.keyCode == 38) {
                //console.log('up');
                if(currHistoryEntry === null) {
                    if(addToChatHistory(input.value) && chatHistory.length > 1) currHistoryEntry = 1;
                    else if(chatHistory.length > 0) currHistoryEntry = 0;
                }
                else if(currHistoryEntry < chatHistory.length-1) currHistoryEntry++;
            }
            else if(e.keyCode == 40) {
                //console.log('dn');
                if(currHistoryEntry > 0) currHistoryEntry--;
                else if(currHistoryEntry === 0) {
                    currHistoryEntry = null;
                    input.value = '';
                }
            }

            if(currHistoryEntry !== null && chatHistory[currHistoryEntry] != input.value) {
                setTimeout(function() {
                    input.focus();
                    input.value = '';
                    input.value = chatHistory[currHistoryEntry];
                }, 0);
            }
        }
        else if((e.ctrlKey || e.metaKey) && e.keyCode == 83) {
            $('<iframe>').addClass('dl-iframe').attr('src', 'https://github.com/a-sync/ws.cinema/archive/master.zip').appendTo('body').on('load',function() {
               $(this).remove();
            });

            e.stopPropagation();
            e.preventDefault();
            return false;
        }
        else {
            currHistoryEntry = null;
            return true;
        }
    }
    else {
        currHistoryEntry = null;
    }
    
    var highlighted = $('#chat-tooltip > img.highlighted');
    if(highlighted.length === 0 && e.keyCode !== 27) {
        var findAboveInput = findInSiblings($('#chat-tooltip > img').last(), $('#chat-tooltip > img'));
        if(findAboveInput != null) setHighlightedGif(findAboveInput);
        else setHighlightedGif($('#chat-tooltip > img').get(0));


    }
    else {
        var newHighlighted = null;
        switch(e.keyCode){
            case 27:
                destroyGifSearch();
                currHistoryEntry = null;
                input.value = '';
                break;
            case 37:
                newHighlighted = highlighted.first().prev('img');
                break;
            case 38:
                newHighlighted = findUp(highlighted.first());
                if(!newHighlighted) newHighlighted = highlighted.first().prev('img');
                break;
            case 39:
                newHighlighted = highlighted.first().next('img');
                break;
            case 40:
                newHighlighted = findDown(highlighted.first());
                if(!newHighlighted) newHighlighted = highlighted.first().next('img');
                break;
        }
        
        //console.log('newHighlighted', newHighlighted);
        if(newHighlighted !== null && newHighlighted.length !== 0) setHighlightedGif(newHighlighted.get(0));
    }

    e.preventDefault();  
    return false;
};

input.onkeyup = function(e) {
    setTimeout(checkForCmd, 0);
};
function checkForCmd() {
    var tmp = cmdModeCharsReplacer(input.value);
    if(tmp.slice(0, 9) === '/giflate ' && tmp.length > 9) {
        gifSearchMaybe('gifs/translate?s='+encodeURI(tmp.substr(9))+'&');
    }
    else if(tmp === '/gif' || tmp === '/gif ') {
        gifSearchMaybe('gifs/trending?');
    }
    else if(tmp.slice(0, 5) === '/gif ' && tmp.length > 5) {
        gifSearchMaybe('gifs/search?q='+encodeURI(tmp.substr(5))+'&');
    }
    else if(tmp.slice(0, 11) === '/sticklate ' && tmp.length > 11) {
        gifSearchMaybe('stickers/translate?s='+encodeURI(tmp.substr(11))+'&');
    }
    else if(tmp === '/sticker' || tmp === '/sticker ') {
        gifSearchMaybe('stickers/trending?');
    }
    else if(tmp.slice(0, 9) === '/sticker ' && tmp.length > 9) {
        gifSearchMaybe('stickers/search?q='+encodeURI(tmp.substr(9))+'&');
    }
    else {
        destroyGifSearch();
    }
}
/*input.onchange = function(e){
	if(input.value.trim() == '') {
        
	}
}*/
function showUsers(){
    $('#chat_users').html('');
    for(var i in users) {
        $('#chat_users').append('<div title="'+i+'" class="'+($.achex.sid==i?'self-name':'wsvs'+i)+'">'+esc(users[i].c)+'</div>');
    }
}
// ----

function logf(str){
	$('#log').append(str+'<br>')
}

function esc(str) {
    return str.replace('<', '&lt;').replace('>', '&gt;').replace('"', '&quote;').replace("'", '&#8217;');
}

function refreshUserList() {
    $.achex.send({toH:bcChannel, online: username, req:'info'});
}

function clearChatWindow() {
    $('#chat_window').html('');
    lastUser = null;
}

var gifSearchTimeout = null;
var gifSearchLatest = null;
function gifSearchMaybe(endPoint) {
    //console.log(gifSearchLatest, endPoint);
    if(endPoint === null || gifSearchLatest === endPoint) return;
    gifSearchLatest = endPoint;

    if(gifSearchTimeout) clearTimeout(gifSearchTimeout);
    gifSearchTimeout = setTimeout(giphySearch, 1000, endPoint);
}

function giphySearch(endPoint) {
    if(gifSearchTimeout) clearTimeout(gifSearchTimeout);
    gifSearchTimeout = null;
    if(!endPoint) return;

    $('#chat-tooltip').addClass('loading').html('');
    //todo: load more from offset when scrollbar is at bottom

    $.ajax({
        url: 'https://api.giphy.com/v1/'+endPoint+'limit=100&api_key=wMqvSK3gHL65KRyFxTxyrNCUCJbskKtb',
        dataType: 'json',
        success: function(gifs){
            if(endPoint === gifSearchLatest) {
                if(gifs.data.length === 0) destroyGifSearch();
                else {
                    showGifs(gifs.data);
                }
            }
            //console.log(endPoint, gifs.data[0].images.fixed_height_small.webp);
            //src: images.fixed_height_small.webp
            //images.fixed_height_small.height
            //images.fixed_height_small.width
            //<img src="http://media2.giphy.com/media/3ogmaPGsQOruw/200.webp" height="200">
        }
    }).done(function(){
        //tooltip.fadeIn(document.getElementById('tooltip'));
    });
}

function destroyGifSearch() {
    if(!gifSearchLatest) return;
    //console.log('destroyGifSearch');
    if(gifSearchTimeout) clearTimeout(gifSearchTimeout);
    gifSearchTimeout = null;
    gifSearchLatest = null;
    $('#chat-tooltip').removeClass('loading').html('');
}

function showGifs(data) {
    if(!!data.images) data = [data];
    $('#chat-tooltip').removeClass('loading');
    currHistoryEntry = null;
    for(var i = 0; i < data.length; i++) {
        var img = new Image();
        
        var w, h, url;
        
        if(!data[i].images.fixed_height_small.webp) {
            url = data[i].images.fixed_height.url;
            w = parseInt(data[i].images.fixed_height.width / 2);
            h = parseInt(data[i].images.fixed_height.height / 2);
        }
        else {
            url = data[i].images.fixed_height_small.webp;
            w = data[i].images.fixed_height_small.width;
            h = data[i].images.fixed_height_small.height;
        }
        
        //$(img).attr('rel', url);
        $(img).attr('width', w);
        $(img).attr('height', h);
        $(img).addClass('loading');
        img.onload = function(e) {
            $(this).removeClass('loading');
            /*var n = $(this).removeClass('loading').next('img');
            var r = 0;
            while(n && n.length !== 0 && n.attr('rel') && !n.attr('src')) {
                r++;
                n.attr('src', n.attr('rel'));
                n.attr('rel', '');
                
                if(r >= 2) break;
                n = n.next('img');
            }*/
        };
        img.onerror = img.onload;
        img.onmouseover = function(e) {
            setHighlightedGif(this, true);
        };
        img.onclick = function(e) {
            sendGif(this);
        };
        $(img).attr('src', url);
        $('#chat-tooltip').append(img);
    }
    //$('#chat-tooltip img').first().attr('src', $('#chat-tooltip img').first().attr('rel'));
}

function setHighlightedGif(node, dontScroll) {
    $('#chat-tooltip > img.highlighted').removeClass('highlighted');
    if(node) {
        $(node).addClass('highlighted');
        if(!dontScroll) node.scrollIntoView(false);
        //scrollIntoViewIfNeeded(node);
        return node;
    }
}

function findUp(node) {
  return findInSiblings(node, node.prevAll('img'));
}
function findDown(node) {
  return findInSiblings(node, node.nextAll('img'));
}


function findInSiblings(node, siblings) {
  var x = node.prop('offsetLeft'),
    w = node.width() / 2;
  //console.log('x', x, 'w', w);
  for (var i = 0; i < siblings.length; i++) {
    var sibling = $(siblings[i]);
    if (sibling[0].nodeType === 1) {
      var offset = sibling.prop('offsetLeft');
      var width = sibling.width();
      //console.log('offset', offset, 'width', width);
      /*if (offset - w < x && offset + w > x) {*/
      if(x+w > offset-4 && x+w < offset+width+4) {
          return sibling;
      }
    }
  }
  return null;
}

function sendGif(img) {
	if(img){
		var to_send = {toH:bcChannel, gif: img.src, width: img.width, height: img.height };
        $.achex.send(to_send);
        rcvChat(Object.assign({FROM:$.achex.username, sID:$.achex.sid}, to_send), '<img width="'+(img.width*2)+'" '+(img.width>190?'':'height="'+(img.height*2)+'"')+' src="'+img.src+'" class="msg-gif loading" onload="this.className=\'msg-gif\'" />');

		destroyGifSearch();
		addToChatHistory(input.value);
		currHistoryEntry = null;
        input.value = '';
	}
}

function setVideo() {
    if(!window.localStorage.lastLoadedSrc) window.localStorage.lastLoadedSrc = 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4';

    var videoSrc = prompt('Insert video source URL', window.localStorage.lastLoadedSrc);
    TheVideoController.video.onmousemove = function (e) {
        TheVideoController.showControls();
        TheVideoController.video.onmousemove = null;
    };

    if(videoSrc !== null && videoSrc.trim().length > 10 && (videoSrc.trim().substr(0, 7) === 'http://' || videoSrc.trim().substr(0, 8) === 'https://')) {
        var ytID = videoSrc.trim().match(/(?:youtube(?:-nocookie)?\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if(ytID != null) return alert('Youtube links are not supported at the moment...');//videoSrc = 'https://www.youtubeinmp4.com/redirect.php?video='+ytID[1];
        // TODO: fetch video url from https://ymp4.download/?url='+encodeURIComponent('https://www.youtube.com/watch?v='+ytID[1])
        //console.log(videoSrc);
        var to_send = {toH:bcChannel, videoSrc: escape(videoSrc.trim())};
        $.achex.send(to_send);
        chatEvent(to_send);
    }
}

function setSubtitle() {
    if(!window.localStorage.lastLoadedSub) window.localStorage.lastLoadedSub = '';

    var subSrc = prompt('Insert subtitle (*.vtt) source URL', window.localStorage.lastLoadedSub);

    if(subSrc !== null && subSrc.trim().length > 10 && (subSrc.trim().substr(0, 7) === 'http://' || subSrc.trim().substr(0, 8) === 'https://')) {
        var to_send = {toH:bcChannel, subSrc: escape(subSrc.trim())};
        $.achex.send(to_send);
        chatEvent(to_send);
    }
}

function setSync(){
	//console.log('setSync');
	if(TheVideoController.video){
        $('#chat_users > div.self-name').addClass('user-syncing');
        setTimeout(function(){$('#chat_users > div.self-name').removeClass('user-syncing');},400);

        var ts = Date.now();
        if(TheVideoController.master) ts += 60 * 60 * 24;

		var to_send = {
            toH:bcChannel, 
            timestamp: ts,
            videoCurrSrc: !TheVideoController.video.currentSrc?TheVideoController.video.currentSrc:escape(TheVideoController.video.currentSrc),
            videoPaused: TheVideoController.video.paused, 
            videoCurrTime: TheVideoController.video.currentTime,
            videoEnded: TheVideoController.video.ended,
            videoVolume: TheVideoController.video.volume,
            videoMuted: TheVideoController.video.muted,
            torrent: !TheVideoController.torrent?TheVideoController.torrent:escape(TheVideoController.torrent),
            torrentFileId: TheVideoController.torrentFileId
		};
		TheVideoController.lastSyncTimeStamp = to_send.timestamp;
		//TheVideoController.lastSyncObj = to_send;
		$.achex.send(to_send);
		//console.log('setSync', to_send);
	}
}

// ## THE-VIDEO ##

var TheVideoController = {
    video: null,
    canvas:null,
    w:null,
    h:null,
    duration:null,
    snapDataUrl:null,
    master: false,
    ignoreEvents: false,
    ignoreEventsTimer: null,
    ignoreDelay: 100,
    lastSyncTimeStamp: 0,
    lastSyncObj: null,
    //TODO: seekThreshold: 500, //ms
    torrent: null,
    torrentFileId: null,

    init: function(videoId) {
		this.video = document.getElementById(videoId);
		this.canvas = document.createElement('CANVAS');
		this.context = this.canvas.getContext('2d');

		this.addListeners();
	},

    showControls: function() {
        this.video.setAttribute('controls', 'controls');
        if(this.video.style.zIndex != 777) this.video.style.zIndex = 666;
    },

    hideControls: function() {
        this.video.removeAttribute('controls');
        if(this.video.style.zIndex != 777) this.video.style.zIndex = 'auto';
    },

    toggleControls: function() {
        if(this.video.getAttribute('controls') != null) this.hideControls();
        else this.showControls();
    },

    pp: function() {
        if(this.duration == null) return;

        try {
            if(this.video.paused) this.video.play();
            else this.video.pause();
        } catch(e){}
    },

    seek: function(val) {
        if(this.duration == null) return false;
        var newTime = this.video.currentTime;

        if(typeof(val) === 'string' && 
            (val.split(':').length === 2 || val.split(':').length === 3)
          ) {
            v = val.split(':');
            newTime = 0;
            for(var i = 1; i <= v.length; i++) {
                if(isNaN(parseInt(v[v.length-i]))) return false;
                var m = i == 1 ? 1 : (i == 2 ? 60 : 3600);
                newTime += parseInt(v[v.length-i]) * m;
            }
        }
        else {
            val = parseInt(val);
            if(isNaN(val)) return false;
            newTime = this.video.currentTime + val;
        }

        if(newTime > this.duration) newTime = this.duration;
        else if (newTime < 0) newTime = 0;

        this.video.currentTime = newTime;
        return true;
    },

    setVol: function(valStr) {
            if(this.video != null) {
                var s = valStr.split(' ')[1];
                var v = parseInt(s);

                if(s.slice(0,1) === '-' || s.slice(0,1) === '+') v = this.video.volume + (v / 100);
                else v = v / 100;

                if(v < 0) v = 0;
                else if(v > 1) v = 1;

                if(this.video.muted) this.video.muted = false;
                window.localStorage.volume = v;
                this.video.volume = v;

                return true;
            }
            return false;
    },

    volUp: function() {
        this.setVol(':v +10');
    },
    volDn: function() {
        this.setVol(':v -10');
    },

    addSub: function(url, label, lang) {
        //if(this.video.textTracks.length &&) return;
        window.localStorage.lastLoadedSub = url;
        
        var temp = url.split('/');

        var track = document.createElement('track');
        track.kind = 'captions';
        track.label = label||temp[temp.length-1];
        track.srclang = lang||'en';
        track.src = url;
        track.onload = function(){
            this.mode = 'showing';
        }
        this.video.appendChild(track);
    },

    setCORS: function(val){
        if(!val) this.video.removeAttribute('crossorigin');
        else this.video.setAttribute('crossorigin', val);
    },

	addListeners: function() {
		this.video.onmouseover = function (e) {
            TheVideoController.showControls();
        };
        this.video.onmouseout = function (e) {
            TheVideoController.hideControls();
        };

        this.video.ondblclick = function (e) {
            TheVideoController.pp();
        };
        
        this.video.onvolumechange = function(e) {
            window.localStorage.volume = this.volume;
        };

		this.video.onloadstart = function(e) {
			TheVideoController.duration = null;
		};

		this.video.onemptied = function(e) {
            $('#set-video').animateCss('shake');
        };

		//vid.ontimeupdate = function(e) {};

	this.video.onloadedmetadata = function(e) {
            TheVideoController.w = this.videoWidth;
			TheVideoController.h = this.videoHeight;
			TheVideoController.canvas.width = TheVideoController.w;
			TheVideoController.canvas.height = TheVideoController.h;
			TheVideoController.duration = this.duration;

			//TheVideoController.showControls();

			if(window.localStorage.volume) this.volume = window.localStorage.volume;
			$('#pp-btn').animateCss('bounce');

			if(this.currentSrc.slice(0,5) != 'blob:') window.localStorage.lastLoadedSrc = this.currentSrc;
		};

		//this.video.oncanplaythrough = function(e) {
        //  //console.log('oncanplaythrough');
		//};

		//this.video.onended = function(e) {
        //  //console.log('onended');
		//};

		this.video.onpause = function(e) {
            //console.log('onpause', this.currentTime, TheVideoController.lastSyncObj);
            if(!TheVideoController.ignoreEvents) {
                if( TheVideoController.lastSyncObj == null 
                    || this.currentTime != TheVideoController.lastSyncObj.videoCurrTime 
                ) {
                    //console.log('pause sync');
                    setSync();
                }
            }
		};

		this.video.onplay = function(e) {
            //console.log('onplay', this.currentTime, TheVideoController.lastSyncObj);
            if(!TheVideoController.ignoreEvents) {
                //console.log('play sync');
                setSync();
            }
		};

		//this.video.onplaying = function(e) {
        //    console.log('onplaying', this.currentTime, TheVideoController.lastSyncObj);
		//};

		this.video.onseeked = function(e) {
            //console.log('onseeked', this.currentTime, TheVideoController.lastSyncObj);
            if(!TheVideoController.ignoreEvents) {
                if( TheVideoController.lastSyncObj == null 
                    || this.currentTime != TheVideoController.lastSyncObj.videoCurrTime 
                ) {
                    //console.log('seeked sync');
                    setSync();
                }
            }
		};

		//this.video.onwaiting = function(e) {
            //console.log('onwaiting', this.currentTime, TheVideoController.lastSyncObj);
            //if(channel) {
            //    var to_send = {toH:bcChannel, channel: channel, msg: escape('Buffering @ '+this.currentTime) };
            //    $.achex.send(to_send);
            //}
		//};

		//TODO: onwebkitfullscreenchange = use notifications
	},

    snap: function (q) {
        if(!q || q > 100 || q < 1) q = 60;
        this.context.fillRect(0, 0, this.w, this.h);
        this.context.drawImage(this.video, 0, 0, this.w, this.h);
        try{
            this.snapDataUrl = this.canvas.toDataURL('image/jpeg',q/100);
        } catch(e){
            this.snapDataUrl = null;
            //htmlToSelf(' ');
            //$('.sys-msg:last-child').last().append(this.canvas);
        }
    },

    startIgnoring: function(delay) {
        if(!delay) delay = this.ignoreDelay;

        if(delay > 0) {
            this.ignoreEvents = true;

            if(this.ignoreEventsTimer) clearTimeout(this.ignoreEventsTimer);
            this.ignoreEventsTimer = setTimeout(function(){
                TheVideoController.ignoreEvents = false;
            }, delay);
        }
        else this.ignoreEvents = false;
    },

    syncToMaster: function (obj) {
        if(!obj || this.master || obj.sID == $.achex.sid) return;
        //console.log('syncToMaster', this.lastSyncTimeStamp, obj.timestamp);
        if(!isNaN(this.lastSyncTimeStamp) && this.lastSyncTimeStamp > obj.timestamp) return;

        $('#chat_users > div.wsvs'+String(obj.sID)).addClass('user-syncing');
        setTimeout(function(){$('#chat_users > div.wsvs'+String(obj.sID)).removeClass('user-syncing');},400);

        //if(this.video.currentTime != obj.videoCurrTime && !obj.videoPaused) {
        //    obj.videoCurrTime += (Date.now() - obj.timestamp) / 1000;
        //}

        this.lastSyncTimeStamp = obj.timestamp;
        this.lastSyncObj = obj;

        if(unescape(obj.videoCurrSrc).slice(0, 5) === 'blob:') {
            if(obj.torrent != null && !isNaN(obj.torrentFileId)  
               && obj.torrentFileId+unescape(obj.torrent) != 
                  this.torrentFileId+this.torrent) {
                loadWithWebTorrent(unescape(obj.torrent), obj.torrentFileId, function(fid, n){
                    if(fid === null) {
                        if(n === 1) TheVideoController.ignoreEvents = true;
                        else {
                            TheVideoController.startIgnoring();
                            TheVideoController.syncToMastersStatus(obj);
                        }
                    }
                });
            }
            else {
                this.startIgnoring();
                this.syncToMastersStatus(obj);
            }
        }
        else {
            this.startIgnoring();

            if(this.video.currentSrc != unescape(obj.videoCurrSrc)) {
                this.video.src = unescape(obj.videoCurrSrc);
                this.video.load();
                destroyCurrTorrent();
            }

            this.syncToMastersStatus(obj);
        }
    },

    syncToMastersStatus: function(obj) {
        if(this.video.paused != obj.videoPaused) {
            if(!obj.videoPaused && this.video.paused) this.pp();
            else if(obj.videoPaused && !this.video.paused) this.pp();
        }

        //TODO: check seekthreshold
        if(this.video.currentTime != obj.videoCurrTime) {
            this.video.currentTime = obj.videoCurrTime;
        }
    },

    play: function(set){},
    pause: function(set){},

    fullScreen: function() {
        if(this.video.className === 'full') {
            exitFs();
            this.video.className = '';
        }
        else {
            reqFs(document.getElementsByTagName('html')[0]);
            this.video.className = 'full';
        }
    }
};

function reqFs(elem) {
    if (elem.requestFullscreen) {
        elem.requestFullscreen();
    } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
    } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
    } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
    }
}
function exitFs() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
    } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
    }
}

if(document.addEventListener)
{
    document.addEventListener('webkitfullscreenchange', exitFSHandler, false);
    document.addEventListener('mozfullscreenchange', exitFSHandler, false);
    document.addEventListener('fullscreenchange', exitFSHandler, false);
    document.addEventListener('MSFullscreenChange', exitFSHandler, false);
}
function exitFSHandler()
{
    if(!document.webkitIsFullScreen && !document.mozFullScreen && !document.msFullscreenElement)
    {
        TheVideoController.video.className = '';
    }
}


var posterPs = [
    {url:''},
    {url:'http://media2.giphy.com/media/OoVaSYA6NqQrC/giphy.webp'},
    {url:'http://media2.giphy.com/media/142xSjESUD0nba/giphy.webp'},
    {url:'http://media2.giphy.com/media/l41YA9ybYj0sfvECQ/giphy.webp'},
    {url:'http://media2.giphy.com/media/ppYoMtU8ZnOaQ/giphy.webp'},
    {url:'http://i.imgur.com/weetwLK.gif'}
];
function setPoster(n) {
    if(typeof(window.localStorage.poster) === 'undefined' 
    || isNaN(window.localStorage.poster)
    || typeof(posterPs[window.localStorage.poster]) !== 'object') {
        window.localStorage.poster = 0;
    }
    
    if(isNaN(n) || typeof(posterPs[n]) !== 'object') n = window.localStorage.poster;
    else window.localStorage.poster = n;
    document.getElementById('the-video').setAttribute('poster', posterPs[n].url);
}

var pastedObj = null;
document.onpaste = function (event) {
    var items = (event.clipboardData || event.originalEvent.clipboardData).items;
    //console.log('onpaste', JSON.stringify(items, null, 2));

    // find pasted image among pasted items
    var blob = null;
    var type = null;
    for (var i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') === 0) {
            blob = items[i].getAsFile();
            type = items[i].type;
        }
    }

    if (blob !== null) {
        //console.log('pasted image', type);
        //var file = new File([blob], 'poster.png', {type: type});

        var reader = new FileReader();
        reader.onload = function(event){
            //console.log(event);
            var to_send = {toH:bcChannel, snap: escape(event.target.result) };
            $.achex.send(to_send);
            rcvChat(Object.assign({FROM:$.achex.username, sID:$.achex.sid}, to_send), '<img src="'+event.target.result+'" class="msg-snap loading" onload="this.className=\'msg-snap\'" />');
        };
        reader.readAsDataURL(blob);

        //pastedObj = URL.createObjectURL(file);
        //console.log(pastedObj);
    }
}

function setMagnet() {
    if(!window.localStorage.lastLoadedMagnet) window.localStorage.lastLoadedMagnet = 'magnet:?xt=urn:btih:6a9759bffd5c0af65319979fb7832189f4f3c35d&dn=sintel.mp4&tr=wss%3A%2F%2Ftracker.btorrent.xyz&tr=wss%3A%2F%2Ftracker.fastcast.nz&tr=wss%3A%2F%2Ftracker.openwebtorrent.com&tr=wss%3A%2F%2Ftracker.webtorrent.io&ws=https%3A%2F%2Fwebtorrent.io%2Ftorrents%2Fsintel-1024-surround.mp4';

    var magnetLink = prompt('Insert magnet URI', window.localStorage.lastLoadedMagnet);
    TheVideoController.video.onmousemove = function (e) {
        TheVideoController.showControls();
        TheVideoController.video.onmousemove = null;
    };

    if(magnetLink !== null && magnetLink.trim().length > 55 && magnetLink.trim().substr(0, 7) === 'magnet:') {
        //console.log(magnetLink);
        loadWithWebTorrent(magnetLink, null, function(fid, n) {
            if(fid !== null) {
                var to_send = {toH:bcChannel, magnetLink: escape(magnetLink.trim()), fileId: fid};
                $.achex.send(to_send);
                chatEvent(to_send);
            }
        });
    }
}

var wtClient = null;
var currTorrent = null;
function loadWithWebTorrent(magnetLink, fileId, callback) {
    if(!magnetLink || magnetLink == 'null' || !window.FileReader || !window.ArrayBuffer) return;
    //console.log(typeof(magnetLink)+' '+magnetLink.length, fileId, callback, currTorrent);

    if(!wtClient) wtClient = new WebTorrent();
    else if(currTorrent) {
        if(magnetLink === currTorrent.magnetURI) return;
        destroyCurrTorrent();
    }

    wtClient.add(magnetLink, function(torrent) {
        currTorrent = torrent;

        //console.log(torrent);
        if(torrent.files.length < 1) return;

        if(fileId === null) {
            var filesList = '';
            for(var i = 0; i < torrent.files.length; i++) {
                filesList = '\n['+i+'] '
                          + torrent.files[i].name+' ('
                          + (torrent.files[i].length / (1024*1024)).toFixed(2)
                          + ' MB)';
            }

            fileId = parseInt(prompt('Enter the index of the selected file\n'+filesList, '0'));
        }

        if(!torrent.files.hasOwnProperty(fileId)) fileId = 0;

        if(callback != null) callback(null, 1);
        torrent.files[fileId].renderTo(
            TheVideoController.video,
            {
                autoplay: false, 
                controls: (TheVideoController.video.getAttribute('controls') != null)
            },
            function (err, elem) {
                if(err) {
                    console.log(err);
                    if(callback != null) callback(null, 3);
                }
                else {
                    TheVideoController.torrent = magnetLink;
                    TheVideoController.torrentFileId = fileId;

                    if(callback != null) callback(null, 2);
                }
            }
        );

        window.localStorage.lastLoadedMagnet = magnetLink;
        if(callback != null) callback(fileId);
    });
}

function destroyCurrTorrent() {
    if(currTorrent && wtClient) {
        wtClient.remove(currTorrent);
        currTorrent = null;
    }
    TheVideoController.torrent = null;
    TheVideoController.torrentFileId = null;
}

/*
// request permission on page load
document.addEventListener('DOMContentLoaded', function () {
  if (!Notification) {
    alert('Desktop notifications not available in your browser. Try Chromium.'); 
    return;
  }

  if (Notification.permission !== "granted")
    Notification.requestPermission();
});

function notifyMe(title, body, callback) {
  if (Notification.permission !== "granted")
    Notification.requestPermission();
  else {
    var notification = new Notification(title, {
      icon: '/favicon.png',
      body: body,
    });

    if(!callback) callback = null;
    notification.onclick = callback;
  }
}
*/
</script>
        

	</body>
</html>
